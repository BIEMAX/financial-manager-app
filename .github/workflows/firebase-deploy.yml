# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase

on:
  push:
    branches:
      - "fix/firebase_deploys"
      - "develop"
      - "master"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checking branch name
        run: echo Running on branch ${GITHUB_REF##*/}
      - name: 2. Checkout repository
        uses: actions/checkout@v3
      - name: 3. Setup Node JS
        uses: actions/setup-node@master
        with:
          node-version: "14.20.0"
      - name: 4. Installing dotenv package
        run: npm install --dotenv-extended

      # Staging env
      - name: 5. STG - Loading configurations
        if: github.ref_name == 'develop'
        run: node create_env.js
        env:
          ENVIRONMENT_CONTENT: "${{ secrets.STAGING_ENVIRONMENT }}"
          ENVIRONMENT: "stg"
      # Production env
      - name: 5. PRD - Loading configurations
        if: github.ref_name == 'main'
        run: node create_env.js
        env:
          ENVIRONMENT_CONTENT: "${{ secrets.PRODUCTION_ENVIRONMENT }}"
          ENVIRONMENT: "prd"
      # Test only
      - name: 5. TST - Loading configurations
        if: github.ref_name == 'fix/firebase_deploys'
        run: node create_env.js
        env:
          ENVIRONMENT_CONTENT: "${{ secrets.STAGING_ENVIRONMENT }}"
          ENVIRONMENT: "stg"

      # Staging env
      - name: 6. STG - Building project
        if: github.ref_name == 'develop'
        run: npm ci && npm run build-hml
      - name: 7. STG - Deploying to firebase
        if: github.ref_name == 'develop'
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: "${{ secrets.GITHUB_TOKEN }}"
          firebaseServiceAccount: "${{ secrets.FIREBASE_SERVICE_ACCOUNT_FINANCIAL_MANAGER_STAGING }}"
          channelId: live
          projectId: financial-manager-staging
      # Production env
      - name: 6. PRD - Building project
        if: github.ref_name == 'main'
        run: npm install && npm ci && npm run build-hml
      - name: 7. PRD - Deploying to firebase
        if: github.ref_name == 'main'
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: "${{ secrets.GITHUB_TOKEN }}"
          firebaseServiceAccount: "${{ secrets.FIREBASE_SERVICE_ACCOUNT_FINANCIAL_MANAGER_STAGING }}"
          channelId: live
          projectId: financials-manager
      # Test only
      - name: 6. TST - Building project
        if: github.ref_name == 'fix/firebase_deploys'
        run: npm install && npm run build-hml
      - name: 7. TST - Deploying to firebase
        if: github.ref_name == 'fix/firebase_deploys'
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: "${{ secrets.GITHUB_TOKEN }}"
          firebaseServiceAccount: "${{ secrets.FIREBASE_SERVICE_ACCOUNT_FINANCIAL_MANAGER_STAGING }}"
          channelId: live
          projectId: financial-manager-staging
