# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase on merge

on:
  push:
    branches:
      - "fix/firebase_deploys"
      - "develop"
      - "master"

jobs:
  branch-validation:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checking branch name
        run: echo Running on branch ${GITHUB_REF##*/}
      - name: 2. Checkout repository
        uses: actions/checkout@master

  installation:
    needs: branch-validation
    runs-on: ubuntu-latest
    steps:
      - name: 3. Setup Node JS
        uses: actions/setup-node@master
        with:
          node-version: "14.18.0"
      - name: 4. Installing dotenv package
        run: npm install --dotenv-extended

  setup-config:
    needs: installation
    runs-on: ubuntu-latest
    steps:
      # Staging env
      - name: 5. Loading staging environment config
        if: github.ref_name == 'develop'
        run: node create_env.js
        env:
          ENVIRONMENT_CONTENT: "${{ secrets.STAGING_ENVIRONMENT }}"
          ENVIRONMENT: "stg"
      # Production env
      - name: 5. Loading production environment config
        if: github.ref_name == 'main'
        run: node create_env.js
        env:
          ENVIRONMENT_CONTENT: "${{ secrets.PRODUCTION_ENVIRONMENT }}"
          ENVIRONMENT: "prd"
      # Test only
      - name: 5. Loading hotfix environment config
        if: github.ref_name == 'fix/firebase_deploys'
        run: node create_env.js
        env:
          ENVIRONMENT_CONTENT: "${{ secrets.STAGING_ENVIRONMENT }}"
          ENVIRONMENT: "stg"

  build-and-deploy:
    needs: setup-config
    runs-on: ubuntu-latest
    steps:
      # Staging env
      - name: 6. Building project for stagging environment
        if: github.ref_name == 'develop'
        run: npm ci && npm run build-hml
      - name: 7. Defining firebase configurations
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: "${{ secrets.GITHUB_TOKEN }}"
          firebaseServiceAccount: "${{ secrets.FIREBASE_SERVICE_ACCOUNT_FINANCIAL_MANAGER_STAGING }}"
          channelId: live
          projectId: financial-manager-staging
      # Production env
      - name: 6. Building project for production environment
        if: github.ref_name == 'main'
        run: npm ci && npm run build-prd
      - name: 7. Defining firebase configurations
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: "${{ secrets.GITHUB_TOKEN }}"
          firebaseServiceAccount: "${{ secrets.FIREBASE_SERVICE_ACCOUNT_FINANCIAL_MANAGER_STAGING }}"
          channelId: live
          projectId: financials-manager
      # Test only
      - name: 6. Building project for stagging environment
        if: github.ref_name == 'fix/firebase_deploys'
        run: npm ci && npm run build-hml
      - name: 7. Defining firebase configurations
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: "${{ secrets.GITHUB_TOKEN }}"
          firebaseServiceAccount: "${{ secrets.FIREBASE_SERVICE_ACCOUNT_FINANCIAL_MANAGER_STAGING }}"
          channelId: live
          projectId: financial-manager-staging
